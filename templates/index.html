<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Websocket testing tools</title>
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col s12">
            <h4 class="center" style="font-family: Bitstream Vera Sans Mono, Monaco, Courier New, Courier, monospace">
                Websocket API testing tools
            </h4>
            <hr style="width: 100%; height: 5px">
        </div>
        <div class="col s12">

            <div class="row">
                <div class="input-field col s2">
                    <select id="method" style="font-size: small; font-family: 'Courier New', Monospace">
                        <option value="list">List</option>
                        <option value="retrieve">retrieve</option>
                        <option value="update">update</option>
                    </select>
                    <label>Method Select</label>
                </div>
                <div class="input-field col s9">
                    <input type="url" style="font-size: small; font-family: 'Courier New', Monospace" name="" id="url"
                           placeholder="Enter a url"
                           style="font-family: 'Courier New', Monospace">
                </div>
                <div class="input-field col s1">
                    <input type="button" class="btn btn-large" name="" id="" value="GET" onclick="fetchData()">
                </div>
            </div>
            <div class="row">
                <div class="input-field col s4">
                    <input type="tel" name="" id="pk" placeholder="Enter a pk"
                           style="font-size: small; font-family: 'Courier New', Monospace">
                    <label for="pk">
                        for retrieve , update and delete only
                    </label>
                </div>
                <div class="input-field col s8">
                    <label for="data">
                        update, create only
                    </label>
                    <textarea name="" id="data" cols="30" rows="10"
                              style="font-size: small; font-family: 'Courier New', Monospace">
                                {"foo":"sample"}
                    </textarea>
                </div>

            </div>

        </div>
        <div class="col s12">
            <h6>Output</h6>
        </div>
        <div class="col s12 #fafafa grey lighten-5" height="300" style="overflow: scroll">
            <re>
                <code id="output">

                </code>
            </re>
        </div>
    </div>
</div>


<!-- Compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var elems = document.querySelectorAll('select');
        var instances = M.FormSelect.init(elems);
    });
</script>
<script>

    function fetchData() {
        {#const url = "ws://loclahost:8000/test/ws/v1/simple"#}
        const url = document.getElementById('url').value
        console.log(url)
        const method = document.getElementById('method').value
        console.log(method)
        const pk = document.getElementById('pk').value
        console.log(pk)
        const rest_data = JSON.parse(document.getElementById('data').value)

        const ws = new WebSocket(url);

        ws.onmessage = function (e) {

            const data = {
                response_code: JSON.parse(e.data).response_code,
                action: JSON.parse(e.data).action,
                request_id: JSON.parse(e.data).request_id,
                data: JSON.parse(e.data).data,
            }
            console.log(data);
            document.getElementById('output').innerHTML = JSON.stringify(data);
        }

        const action = window.setInterval(function () {

            if (method == "list") {
                ws.send(JSON.stringify({
                    action: method,
                    request_id: new Date().getTime(),
                }));
            } else {
                ws.send(JSON.stringify({
                    action: method,
                    request_id: new Date().getTime(),
                    pk: pk,
                }));
            }
            window.clearInterval(action);
        }, 2000)


        ws.onerror = function (error) {
            console.warn(error)
        }

        ws.readyState = function (e) {
            console.log("ready " + e)
        }
    }


</script>
</body>
</html>